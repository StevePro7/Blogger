<html>

<head>
<title>HuguesJohnson.com: Sega Genesis Programming Part 4: Echo Sound Engine</title>
<!-- begin head includes -->

<!-- 2020-05-20 11:40:55 -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Hugues Johnson">
<base target="_top">
<link rel="icon" href="https://huguesjohnson.com/favicon.ico">
<link href="https://www.huguesjohnson.com/rss/rss.xml" rel="alternate" title="RSS feed for all updates" type="application/rss+xml" />
<!-- Apple icons -->
<link rel="apple-touch-icon" href="https://huguesjohnson.com/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="57x57" href="https://huguesjohnson.com/images/apple-touch-icon_57x57.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://huguesjohnson.com/images/apple-touch-icon_76x76.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://huguesjohnson.com/images/apple-touch-icon_120x120.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://huguesjohnson.com/images/apple-touch-icon_152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="https://huguesjohnson.com/images/apple-touch-icon_167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://huguesjohnson.com/images/apple-touch-icon_180x180.png">
<!-- fonts -->
<link href="https://fonts.googleapis.com/css?family=Audiowide|Ubuntu" rel="stylesheet">
<!-- Bootstrap core CSS -->
<script src="https://huguesjohnson.com/bootstrap/450/jquery-3.5.1.slim.min.js"></script>
<script src="https://huguesjohnson.com/bootstrap/450/popper.min.js"></script>
<script src="https://huguesjohnson.com/bootstrap/450/js/bootstrap.min.js"></script>
<link href="https://huguesjohnson.com/bootstrap/450/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap overrides -->
<link href="https://huguesjohnson.com/bootstrap/450/bootstrap-override-2020-05-20.css" rel="stylesheet">
<!-- end head includes -->
</head>

<body>

<!-- begin navbar -->
<nav class="navbar navbar-expand-md navbar-light p-0 sticky-top navbar-custom">
    <a class="navbar-brand navbarurl" href="https://huguesjohnson.com/">HuguesJohnson.com</a>
  <button class="navbar-toggler mr-3" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse flex-grow-1" id="navbarContent">
        <ul class="navbar-nav mr-auto">
		  <li class="nav-item dropdown">
		    <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Software</a>
		    <div class="dropdown-menu" aria-labelledby="dropdown01">
		      <a class="dropdown-item" href="https://huguesjohnson.com/rc89/">Retail Clerk '89</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/narpassword/">NARPassword</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/debigulator.html">Debigulator</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/programming/">Programming Articles</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/archive.html">Archive</a>
		    </div>
		  </li>
		  <li class="nav-item dropdown">
		    <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Retro Gaming</a>
		    <div class="dropdown-menu" aria-labelledby="dropdown01">
		      <a class="dropdown-item" href="https://huguesjohnson.com/features/">Features</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/scans/">Scans</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/guides/">Guides</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/game-hunter/">Game Hunter</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/collecting-apps.html">Collecting Apps</a>
		    </div>
		  </li>
		  <li class="nav-item dropdown">
		    <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Game Hacking</a>
		    <div class="dropdown-menu" aria-labelledby="dropdown01">
		      <a class="dropdown-item" href="https://huguesjohnson.com/aridia/">Aridia</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/eisfrei/">Eisfrei</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/hapsby.html">Hapsby</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/power-ups/">Power-Ups</a>
		      <a class="dropdown-item" href="https://huguesjohnson.com/falcom.html">Falcom Translations</a>
		    </div>
		  </li>
        </ul>
        <ul class="navbar-nav">
			<li class="nav-item dropdown">
            	<a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Connect</a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="https://huguesjohnson.com/rss/rss.xml"><img border="0" src="https://huguesjohnson.com/images/feed-icon-16x16.gif" alt="Site RSS">&nbsp;Subscribe</a>
                        <a rel="me" class="dropdown-item" href="https://www.linkedin.com/in/huguesjohnson"><img border="0" src="https://huguesjohnson.com/images/l-16x16.gif" alt="LinkedIn profile">&nbsp;LinkedIn</a>
                        <a rel="me" class="dropdown-item" href="https://github.com/huguesjohnson"><img border="0" src="https://huguesjohnson.com/images/github-16x16.gif">&nbsp;GitHub</a>
                        <a class="dropdown-item" href="https://huguesjohnson.com/podcasts.html"><img border="0" src="https://huguesjohnson.com/images/podcast-16.png">&nbsp;Podcasts</a>
                        <a class="dropdown-item" href="https://huguesjohnson.com/links.html"><img border="0" src="https://huguesjohnson.com/images/link-16.png">&nbsp;Other Links</a>
                        <a class="dropdown-item" href="https://huguesjohnson.com/contact.html"><img border="0" src="https://huguesjohnson.com/images/mail-16x16.png">&nbsp;Contact</a>
                        <a class="dropdown-item" href="https://huguesjohnson.com/bio.html"><img border="0" src="https://huguesjohnson.com/images/q16x16.png">&nbsp;About Me</a>
                        <a class="dropdown-item" href="https://meloniejohnson.com/"><img border="0" src="https://huguesjohnson.com/images/mj16x16.png">&nbsp;Melonie Johnson</a></a>
                    </div>
                </li>
            </ul>
    </div>
</nav>
<!-- end navbar -->

<div class="jumbotron jumbotron-fluid jumbotron-custom" style="background-image: url(https://huguesjohnson.com/images/banner/md.png)">
  <div class="container">
		<h1 class="blog-title"><img src="logo.png" alt="Sega Genesis Programming Part 4: Echo Sound Engine" class="img-fluid" /></h1>
  </div>
</div>

<!-- start breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb breadcrumb-custom">
    <li class="breadcrumb-item"><a href="https://huguesjohnson.com/">home</a></li>
    <li class="breadcrumb-item active" aria-current="page"><a href="https://huguesjohnson.com/software-index.html">software</a></li>
    <li class="breadcrumb-item active" aria-current="page"><a href="https://huguesjohnson.com/programming/">programming articles</a></li>
    <li class="breadcrumb-item active" aria-current="page">sega genesis programming part 4: echo sound engine</li>
  </ol>
</nav>
<!-- end breadcrumb -->


<div class="container-fluid">

	<div class="row">
		<div class="col">
			<a class="float-left" href="https://huguesjohnson.com/programming/genesis/animated-sprites/">&lt;- Part 3: Sprite Animation</a>
		</div>
		<div class="col">
			<a class="float-right" href="https://huguesjohnson.com/programming/genesis/collision-detection/">Part 5: Collision Detection -&gt;</a>
		</div>
	</div>
	<br>

<p class="lead">The Echo Sound Engine</p>

<p><b>** Kind of important note: there is a bug in this tutorial that is corrected in <a href="https://huguesjohnson.com/programming/genesis/game-state/">part 8: game state and pausing</a> **</b></p>

<p>This is going to be a rather short one because there's very little coding involved, very little coding for me at least.</p>
<p>In the <a href="https://huguesjohnson.com/programming/genesis/animated-sprites/">last part</a> I speculated that I'd next &quot;<i>either add some scenery and collision detection, or take a stab at music</i>&quot;. Once I started looking into the latter I found it was simpler than expected. Well, the playing music part is simpler but the creating music part is still a bit tricky.</p>

<p>There is an open source project called <a href="https://github.com/sikthehedgehog/Echo">Echo</a> that provides a sound engine and samples that took about 5 minutes to add. I started by pulling the <a href="https://github.com/sikthehedgehog/Echo/tree/master/src-68k">68k source</a> and making a few small changes to address warnings from <a href="https://sun.hasenbraten.de/vasm/">vasm</a>. The author noted using asm68k and in my (brief) experience I've found it and vasm disagree on when a label is being reassigned.</p>

<p>In my init method, I pulled the routines to initiate the Z80 &amp; PSG and replaced them with:</p>

<div class="well">
<p>InitEcho:</p>
<p>&nbsp;bsr.w Echo_Init</p>
</div>

<p>The code additions were really light too:</p>

<div class="well">
<p>StartBGM:</p>
<p>&nbsp;lea BGM_Test,a0</p>
<p>&nbsp;bsr Echo_PlayBGM</p>
<p>[...]
<p>BGM_Test:</p>
<p>&nbsp;incbin 'bgm_jtxmas.esf'</p>
</div>

<p>After these additions my previous demo was exactly the same only now there's xmas-like music playing in the background. The original setting of a mall in 1989 is now a more specific &quot;mall during the 1989 holiday season&quot; until I change my mind.</p>

<p>Getting that .esf file created was by far more work...</p>

<br/>

<p class="lead">Converting .xm to .esf</p>

<p>Echo uses a proprietary format for its audio files. That's not a problem because it's possible to convert .xm (FastTracker) files to it. There are only two issues with that:</p>
<p>1) All the tools run on Windows, minor issue because I have a few virtual machines on standby at all times.</p>
<p>2) To make everything sound good you need to know a little about how trackers work, bigger issue for me at the moment because it's something I need to learn.</p>
<p>There's also a general issue of me not knowing jack about composing music.</p>
<p>The first order of business is pulling down a copy of <a href="https://github.com/oerg866/xm2esf">xm2esf</a> including the VB6 GUI to create the .xm -> .esf conversion settings. It makes me happy to see an active project using VB6.</p>

<p>Then you need to grab some .xm files, there are a ton that are free to use over at <a href="https://modarchive.org/">The Mod Archive</a>.</p>

<p>The next part is a little tricky, you need to run the xm2esf GUI, open the .xm file you want to convert, and create the channel &amp; instrument mappings.</p>

<p><img src="xm2esf.png" alt="xm2esf" class="img-fluid d-block mx-auto"/></p>

<p>I found this somewhat non-intuitive because I'm not familiar with tracker files. There's <a href="https://devster.proboards.com/thread/1087/echo-sound-engine-setup-tutorial">a tutorial</a> I found helpful which recommended analyzing the .xm file in <a href="https://openmpt.org/">OpenMPT</a>. That was useful because it showed how many instruments there were and which channels are playing what. The .esf file I created didn't sound identical to the source but it was easy to tell they were the same song. As I experiment with this more the results will get better and for the moment I'm happy just to get to this point.</p>

<p><a href="https://github.com/huguesjohnson/RetailClerk89">Download the latest source code on GitHub</a></p>


	<br>	
	<div class="row">
		<div class="col">
			<a class="float-left" href="https://huguesjohnson.com/programming/genesis/animated-sprites/">&lt;- Part 3: Sprite Animation</a>
		</div>
		<div class="col">
			<a class="float-right" href="https://huguesjohnson.com/programming/genesis/collision-detection/">Part 5: Collision Detection -&gt;</a>
		</div>
	</div>
	<br>

<hr>

<p class="lead blog-description">Related</p>

<div class="row container">

<div class="col-sm"><a href="https://huguesjohnson.com/rc89/"><p><img class="img-thumbnail" src="https://huguesjohnson.com/images/related/rc89.png" alt="Retail Clerk '89"></p><p>Retail Clerk '89</p></a></div>

<div class="col-sm"><a href="https://huguesjohnson.com/programming/genesis/game-state/"><p><img class="img-thumbnail" src="https://huguesjohnson.com/images/related/genesispause.png" alt="Sega Genesis Programming Part 8: Game State and Pausing"></p><p>Sega Genesis Programming Part 8: Game State and Pausing</p></a></div>

<div class="col-sm"><a href="https://huguesjohnson.com/programming/genesis/palette-tile-generation/"><p><img class="img-thumbnail" src="https://huguesjohnson.com/images/related/genesispalettetilegen.png" alt="Sega Genesis Programming Part 20: Palette and Tile Generation"></p><p>Sega Genesis Programming Part 20: Palette and Tile Generation</p></a></div>

</div>

<br clear="all"/>




<!-- begin share -->
<!-- end share -->

<!-- begin support -->

<!-- end support -->

<hr>

<!-- begin footer -->
      <footer>
		<p>All source code and software on this site is distributed under <a href="https://opensource.org/licenses/MIT">The MIT License</a> (copyright 2000-2020 Hugues Johnson) unless otherwise noted. </p>
		<p>All other content on this site is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a> unless otherwise noted.</p>
		<p>All opinions on this site reflect my personal views and do not represent views of my current, or any former, employer.</p>
		<p>Site theme is based on <a href="https://getbootstrap.com">Bootstrap</a> licensed under <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE">The MIT License</a>. Site font is Ubuntu licensed under <a href="https://font.ubuntu.com/ufl/ubuntu-font-licence-1.0.txt">Ubuntu Font License</a>. Navigation logo font is Audiowide licensed under <a href="https://scripts.sil.org/OFL">Open Font License</a>.</p>
		<p>This site does not contain advertisements or sponsored content. I am not remotely interested in either so don't ask.</p>
		<p>Privacy policy: I don't care even a little about who visits this site and make no attempt to track usage. The content delivery network I use happens to collect user agent and IP address but I never look at them. This site does not use cookies.</p>
      </footer>
<!-- end footer -->


    </div><!-- /.container -->


<!-- begin page end -->
<!-- end page end -->

</body>

</html>
